<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BET300 · Slot Express</title>
<meta name="theme-color" content="#0b0f1e"/>
<style>
:root{
  --bg:#0b0f1e; --panel:#121634; --panel2:#0f1330; --border:#1e2150;
  --text:#e8ebff; --muted:#b7b9d6; --ok:#25D366; --accent:#22d3ee; --gold:#ffd166;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;color:var(--text);background:var(--bg);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:
  radial-gradient(900px 500px at 50% -10%, rgba(101,74,255,.25), transparent),
  radial-gradient(700px 350px at 100% 0%, rgba(0,209,255,.18), transparent),
  linear-gradient(180deg,#0b0f1e 0%,#0b0f1e 60%,#0a0d20 100%)}

.container{max-width:1100px;margin:10px auto;padding:0 10px 84px}
.card{background: radial-gradient(120% 100% at 50% 0%, rgba(124,77,255,.08), transparent), var(--panel2);
  border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:0 15px 40px rgba(0,0,0,.35)}
@media(max-width:520px){.container{padding:0 0 84px}.card{border-radius:0;border-left:0;border-right:0;padding:10px}}

.head{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap}
.brand{height:34px;width:auto;font-weight:900;letter-spacing:.5px}
.brand b{font-size:28px;background:linear-gradient(90deg,#9dd6ff,#b498ff);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 6px 22px rgba(0,0,0,.35)}
.pill{background:linear-gradient(90deg,rgba(124,77,255,.15),rgba(0,209,255,.15));border:1px solid var(--border);
  border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
.pill.time{display:flex;gap:8px;align-items:center}
.pill.sound{cursor:pointer;user-select:none}
.count{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:rgba(255,204,0,.15);
  border:1px solid rgba(255,204,0,.35);color:#ffe27a;font-weight:700;font-variant-numeric:tabular-nums}

.topcta{margin-left:auto}
.play{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;font-weight:800;
  background:linear-gradient(90deg,#7cd3ff,#ff8ad6);color:#0a0f20;box-shadow:0 8px 20px rgba(0,0,0,.25);text-decoration:none;border:1px solid rgba(255,255,255,.1)}
.play:active{transform:translateY(1px)}

.grid{display:grid;gap:14px;grid-template-columns:1.2fr .8fr}
@media(max-width:920px){.grid{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px}
.center{text-align:left}
h1,h2,h3,p{margin:0 0 8px}
h1{font-size:24px}
.muted{color:var(--muted)}
.badgeGold{display:inline-block;padding:4px 10px;border-radius:10px;background:linear-gradient(90deg,#ffd166,#ffaf66);color:#0a0f20;font-weight:900}

/* —— SLOT rectangular —— */
.slotShell{position:relative;margin-top:8px}
.machine{position:relative;border-radius:16px;background:#0a1230;border:1px solid #2a2f66;padding:14px}
.machine::before{content:"";position:absolute;inset:-8px;border-radius:20px;border:2px solid rgba(255,255,255,.06);pointer-events:none}
.lightFrame{position:absolute;inset:-6px;border-radius:18px;pointer-events:none}
.light{position:absolute;width:8px;height:8px;border-radius:50%;box-shadow:0 0 8px rgba(255,255,255,.5)}
.slot{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;background:#0b1333;border:1px solid #22295e;border-radius:14px;padding:12px}
.reel{background:#0d163d;border:1px solid #2a3170;border-radius:10px;padding:10px;display:grid;grid-template-rows:1fr 1fr 1fr;gap:10px}
.cell{background:linear-gradient(180deg,#0c1537,#0b112d);border:1px solid #2b356a;border-radius:10px;display:grid;place-items:center;overflow:hidden}
.canvasSym{width:100%;height:100%}

/* Resultado / premio */
.right h2{font-size:28px}
.amount{display:grid;place-items:center;height:56px;border-radius:12px;background:linear-gradient(90deg,#6ca6ff,#9f84ff);font-size:26px;font-weight:900}
.resultBox{margin-top:10px;border:1px solid var(--border);border-radius:12px;padding:12px;background:#0e1437}

/* Dock inferior */
.dock{position:fixed;left:0;right:0;bottom:0;z-index:20;background:linear-gradient(180deg, rgba(11,15,30,0) 0%, rgba(11,15,30,.85) 22%, rgba(11,15,30,.95) 100%);
  padding:10px 14px 14px;display:flex;gap:12px;align-items:center}
.btn{appearance:none;border:none;cursor:pointer;padding:14px 16px;border-radius:14px;font-weight:800;background:linear-gradient(90deg,#6c59ff,#00d1ff);color:#0a0f20;width:100%;
  box-shadow:0 8px 20px rgba(0,0,0,.35)}
.btn:disabled{opacity:.55;cursor:not-allowed}
.btn.ok{background:#25D366;color:#0b0f1e}
.btn.spin{background:linear-gradient(90deg,#FF9A3D,#FF5C39);color:#0b0f1e}
.small{font-size:12px;color:var(--muted)}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(6,10,22,.55);display:none;align-items:center;justify-content:center;z-index:50}
.modal .box{width:min(520px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
.modal h3{margin:0 0 8px}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  background:#0c122f;border:1px solid #26306b;border-radius:10px;padding:8px 10px;display:inline-block}
.actions{display:flex;gap:10px;margin-top:12px}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <div class="head">
      <div class="brand"><b>BET300</b></div>
      <span class="pill">Promo interactiva</span>
      <span class="pill time">⚡ Tiempo limitado <span class="count" id="countdown">--:--</span></span>
      <span class="pill sound" id="soundToggle">🔊 Sonido: <b id="soundState">ON</b></span>
      <a id="playNow" class="play topcta" target="_blank" rel="noopener">🎮 Entrar a la plataforma</a>
    </div>

    <div class="grid">
      <!-- IZQUIERDA -->
      <div class="panel">
        <div class="center">
          <h1>Slot Express · 3 rodillos</h1>
          <p class="muted">
            Líneas: <b>arriba</b>, <b>centro</b>, <b>abajo</b>, <b>↘</b>, <b>↗</b>.
            3 logos <b>BET300</b> = <span class="badgeGold">$10.000</span> ·
            3 iguales = <b>$5.000</b> ·
            2 iguales = <b>$2.000</b> ·
            sin acierto = <b>$1.000</b>.
          </p>
        </div>

        <div class="slotShell">
          <div class="machine">
            <div class="lightFrame" id="lightFrame"></div>
            <div class="slot" id="slot">
              <div class="reel" id="reel1">
                <div class="cell"><canvas class="canvasSym" id="r1t"></canvas></div>
                <div class="cell"><canvas class="canvasSym" id="r1c"></canvas></div>
                <div class="cell"><canvas class="canvasSym" id="r1b"></canvas></div>
              </div>
              <div class="reel" id="reel2">
                <div class="cell"><canvas class="canvasSym" id="r2t"></canvas></div>
                <div class="cell"><canvas class="canvasSym" id="r2c"></canvas></div>
                <div class="cell"><canvas class="canvasSym" id="r2b"></canvas></div>
              </div>
              <div class="reel" id="reel3">
                <div class="cell"><canvas class="canvasSym" id="r3t"></canvas></div>
                <div class="cell"><canvas class="canvasSym" id="r3c"></canvas></div>
                <div class="cell"><canvas class="canvasSym" id="r3b"></canvas></div>
              </div>
            </div>
          </div>
          <div class="small">Tip: mejor visual en vertical 📱</div>
        </div>
      </div>

      <!-- DERECHA -->
      <div class="panel right">
        <div class="amount" id="amount">$0</div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px" id="stampLine"></div>

        <h2 id="title">—</h2>
        <div class="resultBox">
          <div style="color:var(--muted);font-weight:700">Resultado actual</div>
          <div id="resultLine" style="margin-top:6px">—</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dock fijo -->
<div class="dock">
  <button id="spinBtn" class="btn spin">🎰 Girar</button>
  <button id="claimBtn" class="btn ok" disabled>📲 Reclamar</button>
</div>

<!-- Modal premio -->
<div class="modal" id="prizeModal" role="dialog" aria-modal="true">
  <div class="box">
    <h3 id="mTitle">🎉 Premio obtenido</h3>
    <p>Recibís <b id="mPrize">$0</b> extra con tu próxima carga.</p>
    <p>Código: <span class="code" id="mCode">—</span> · <span id="mTs">—</span></p>
    <div class="actions">
      <button class="btn ok" id="mClaim">📲 Reclamar por WhatsApp</button>
      <button class="btn" id="mClose">Cerrar</button>
    </div>
  </div>
</div>

<script>
/* ===== Plataforma + WhatsApp por PC ===== */
const params = new URLSearchParams(location.search);
const pc = (params.get('pc')||'1').trim();
const PLATFORM = "https://alvg.bet300vip.com";
const WPS = {
  "1":"5491131583516",
  "2":"5491126695257",
  "3":"5491125368306",
  "4":"5491150030414"
};
const WP = WPS[pc] || WPS["1"];
document.getElementById('playNow').href = PLATFORM;

/* ===== Antifraude ===== */
const SALT = "bet300-slotx-v3";
function ensureDeviceId(){
  let id = localStorage.getItem('device_id');
  if(!id){ id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`); localStorage.setItem('device_id', id);}
  return id;
}
const DEVICE_ID = ensureDeviceId();
function todayKey(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}
async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("").toUpperCase();
}
async function makeClaimCode(prizeLabel){
  const base = `${DEVICE_ID}|${todayKey()}|${prizeLabel}|${SALT}`;
  const hex = await sha256hex(base);
  return hex.slice(0,10);
}

/* ===== Luces rectangulares ===== */
(function buildRectBulbs(){
  const frame = document.getElementById('lightFrame');
  const colors = ["#ffd166","#8bdcff","#b79dff","#69ffc9"];
  const pad = 6, perSide = 18, total = perSide*4;
  for(let i=0;i<total;i++){
    const d=document.createElement('i'); d.className='light';
    d.style.background=colors[i%colors.length]; d.style.boxShadow=`0 0 10px ${colors[i%colors.length]}`;
    const side = Math.floor(i/perSide); const t = (i%perSide)/(perSide-1);
    if(side===0){ d.style.top=pad+"px"; d.style.left=`calc(${t*100}% - 4px)`; }
    if(side===1){ d.style.right=pad+"px"; d.style.top=`calc(${t*100}% - 4px)`; }
    if(side===2){ d.style.bottom=pad+"px"; d.style.left=`calc(${t*100}% - 4px)`; }
    if(side===3){ d.style.left=pad+"px"; d.style.top=`calc(${t*100}% - 4px)`; }
    d.style.animation=`blink${i%4} 1.2s linear ${i*0.05}s infinite`;
    frame.appendChild(d);
  }
  const style=document.createElement('style');
  style.textContent=`
    @keyframes blink0{0%{opacity:.3}50%{opacity:1}100%{opacity:.3}}
    @keyframes blink1{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
    @keyframes blink2{0%{opacity:.6}50%{opacity:1}100%{opacity:.6}}
    @keyframes blink3{0%{opacity:.9}50%{opacity:.3}100%{opacity:.9}}
  `;
  document.head.appendChild(style);
})();

/* ===== Sonido ===== */
let soundOn=true;
const soundToggle=document.getElementById('soundToggle');
const soundState=document.getElementById('soundState');
soundToggle.addEventListener('click',()=>{ soundOn=!soundOn; soundState.textContent=soundOn?'ON':'OFF'; });
const AudioKit=(()=>{
  const Ctx=window.AudioContext||window.webkitAudioContext;
  const ctx=new Ctx(); let unlocked=false;
  function unlock(){ if(!unlocked){ ctx.resume().catch(()=>{}); unlocked=true; } }
  function click(freq=900,dur=0.04,vol=0.05){
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='square'; o.frequency.value=freq; g.gain.value=0; o.connect(g).connect(ctx.destination);
    const t=ctx.currentTime; g.gain.linearRampToValueAtTime(vol, t+0.005); g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.start(t); o.stop(t+dur);
  }
  function spinTick(){ const id=setInterval(()=>click(860+Math.random()*120,0.03,0.04),90); return ()=>clearInterval(id); }
  function win(){ [880,1175,1568].forEach((f,i)=>setTimeout(()=>click(f,0.12,0.09), i*130)); }
  return {ctx,unlock,spinTick,win};
})();

/* ===== Símbolos (Canvas) ===== */
const SYMBOLS = [
  {name:"STAR", draw:(ctx)=>{drawStar(ctx)}},
  {name:"DIAMOND", draw:(ctx)=>{drawDiamond(ctx)}},
  {name:"CHERRY", draw:(ctx)=>{drawCherry(ctx)}},
  {name:"BELL", draw:(ctx)=>{drawBell(ctx)}},
  {name:"SEVEN", draw:(ctx)=>{drawSeven(ctx)}},
  {name:"BET300", draw:(ctx)=>{drawBetSeal(ctx)}},
];

function baseCanvas(ctx){
  const w=ctx.canvas.width, h=ctx.canvas.height;
  const grad=ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,"#0d1a4e"); grad.addColorStop(1,"#0a1030");
  ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);
  ctx.strokeStyle="#2b356a"; ctx.lineWidth=2; ctx.strokeRect(2,2,w-4,h-4);
}
function drawStar(ctx){
  baseCanvas(ctx);
  const w=ctx.canvas.width, h=ctx.canvas.height;
  const r=Math.min(w,h)*0.24;
  ctx.save(); ctx.translate(w/2,h/2);
  ctx.fillStyle="#ffd166"; ctx.shadowBlur=18; ctx.shadowColor="#ffd166";
  ctx.beginPath();
  for(let i=0;i<5;i++){
    const a=i*Math.PI*2/5 - Math.PI/2;
    ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
    const a2 = a + Math.PI/5;
    ctx.lineTo(Math.cos(a2)*r*0.45, Math.sin(a2)*r*0.45);
  }
  ctx.closePath(); ctx.fill(); ctx.restore();
}
function drawDiamond(ctx){
  baseCanvas(ctx);
  const w=ctx.canvas.width, h=ctx.canvas.height;
  ctx.save(); ctx.translate(w/2,h/2);
  const g=ctx.createLinearGradient(-40,-30,40,50);
  g.addColorStop(0,"#9fe6ff"); g.addColorStop(1,"#5fd1ff");
  ctx.fillStyle=g; ctx.beginPath();
  ctx.moveTo(0,-38); ctx.lineTo(44,0); ctx.lineTo(0,40); ctx.lineTo(-44,0); ctx.closePath(); ctx.fill();
  ctx.restore();
}
function drawCherry(ctx){
  baseCanvas(ctx);
  const w=ctx.canvas.width, h=ctx.canvas.height;
  ctx.save(); ctx.translate(w/2,h/2+10);
  ctx.fillStyle="#ff4568"; ctx.beginPath(); ctx.arc(-18,0,18,0,Math.PI*2); ctx.arc(18,0,18,0,Math.PI*2); ctx.fill();
  ctx.fillStyle="#32d06b"; ctx.fillRect(-2,-40,4,30); ctx.beginPath(); ctx.moveTo(-2,-30); ctx.bezierCurveTo(18,-60,30,-30,16,-10); ctx.strokeStyle="#32d06b"; ctx.lineWidth=5; ctx.stroke();
  ctx.restore();
}
function drawBell(ctx){
  baseCanvas(ctx);
  const w=ctx.canvas.width, h=ctx.canvas.height;
  ctx.save(); ctx.translate(w/2,h/2);
  ctx.fillStyle="#ffcc66"; ctx.beginPath();
  ctx.moveTo(-36,0); ctx.quadraticCurveTo(0,-46,36,0); ctx.lineTo(28,20); ctx.lineTo(-28,20); ctx.closePath(); ctx.fill();
  ctx.fillStyle="#ffc24a"; ctx.beginPath(); ctx.arc(0,22,8,0,Math.PI*2); ctx.fill();
  ctx.restore();
}
function drawSeven(ctx){
  baseCanvas(ctx);
  const w=ctx.canvas.width,h=ctx.canvas.height;
  ctx.save(); ctx.translate(w/2,h/2+10);
  ctx.font="bold 82px system-ui,Segoe UI,Roboto"; ctx.textAlign="center"; ctx.fillStyle="#ffffff";
  ctx.shadowBlur=10; ctx.shadowColor="#ffffff"; ctx.fillText("7",0,16); ctx.restore();
}
function drawBetSeal(ctx){
  baseCanvas(ctx);
  const w=ctx.canvas.width,h=ctx.canvas.height,r=Math.min(w,h)*0.34;
  ctx.save(); ctx.translate(w/2,h/2);
  const g=ctx.createRadialGradient(0,0,8,0,0,r);
  g.addColorStop(0,"#5fe4ff"); g.addColorStop(1,"#1aa9ff");
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle="#0c1740"; ctx.lineWidth=6; ctx.stroke();
  ctx.fillStyle="#0b1235"; ctx.font="900 28px system-ui,Segoe UI"; ctx.textAlign="center";
  ctx.fillText("BET",0,-2); ctx.font="900 24px system-ui,Segoe UI"; ctx.fillText("300",0,22);
  ctx.restore();
}

/* ===== Render ===== */
function drawSymbolToCanvas(canvas, sym){
  const dpr = window.devicePixelRatio || 1;
  const W = Math.floor(canvas.clientWidth * dpr);
  const H = Math.floor(canvas.clientHeight * dpr);
  if(canvas.width !== W){ canvas.width = W; canvas.height = H; }
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  SYMBOLS[sym].draw(ctx);
}

/* ===== Lógica reels ===== */
const N = SYMBOLS.length;
let spinning=false;
const reelFinalIndex=[0,1,2];

const PROB = { jackpot:0.10, triple:0.20, pair:0.35, none:0.35 };

function idxByName(name){ return SYMBOLS.findIndex(s=>s.name===name); }

function pickCenters(){
  const r=Math.random(), pJ=PROB.jackpot, pT=pJ+PROB.triple, pP=pT+PROB.pair;
  if(r<pJ) return [idxByName("BET300"), idxByName("BET300"), idxByName("BET300")];
  if(r<pT){
    let pool = SYMBOLS.map(s=>s.name).filter(n=>n!=="BET300");
    const pick = pool[Math.floor(Math.random()*pool.length)];
    const idx = idxByName(pick);
    return [idx,idx,idx];
  }
  if(r<pP){
    const pick = Math.floor(Math.random()*N);
    let other; do{ other = Math.floor(Math.random()*N);} while(other===pick);
    const pos=Math.floor(Math.random()*3);
    const arr=[pick,pick,pick]; arr[pos]=other; return arr;
  }
  let a,b,c; do{a=Math.floor(Math.random()*N); b=Math.floor(Math.random()*N);}while(b===a);
  do{c=Math.floor(Math.random()*N);}while(c===a||c===b);
  return [a,b,c];
}

function renderFromCenters(c1,c2,c3){
  const triple = [
    [c1, (c1-1+N)%N, (c1+1)%N],
    [c2, (c2-1+N)%N, (c2+1)%N],
    [c3, (c3-1+N)%N, (c3+1)%N]
  ];
  drawSymbolToCanvas(document.getElementById('r1t'), triple[0][1]);
  drawSymbolToCanvas(document.getElementById('r1c'), triple[0][0]);
  drawSymbolToCanvas(document.getElementById('r1b'), triple[0][2]);

  drawSymbolToCanvas(document.getElementById('r2t'), triple[1][1]);
  drawSymbolToCanvas(document.getElementById('r2c'), triple[1][0]);
  drawSymbolToCanvas(document.getElementById('r2b'), triple[1][2]);

  drawSymbolToCanvas(document.getElementById('r3t'), triple[2][1]);
  drawSymbolToCanvas(document.getElementById('r3c'), triple[2][0]);
  drawSymbolToCanvas(document.getElementById('r3b'), triple[2][2]);

  reelFinalIndex[0]=c1; reelFinalIndex[1]=c2; reelFinalIndex[2]=c3;
}

function buildGridFromFinals(){
  return {
    r1:{ top:SYMBOLS[(reelFinalIndex[0]-1+N)%N].name, center:SYMBOLS[reelFinalIndex[0]].name, bottom:SYMBOLS[(reelFinalIndex[0]+1)%N].name },
    r2:{ top:SYMBOLS[(reelFinalIndex[1]-1+N)%N].name, center:SYMBOLS[reelFinalIndex[1]].name, bottom:SYMBOLS[(reelFinalIndex[1]+1)%N].name },
    r3:{ top:SYMBOLS[(reelFinalIndex[2]-1+N)%N].name, center:SYMBOLS[reelFinalIndex[2]].name, bottom:SYMBOLS[(reelFinalIndex[2]+1)%N].name }
  };
}

function evaluateLines(g){
  const lines = [
    {name:"Arriba", arr:[g.r1.top, g.r2.top, g.r3.top]},
    {name:"Centro", arr:[g.r1.center, g.r2.center, g.r3.center]},
    {name:"Abajo",  arr:[g.r1.bottom, g.r2.bottom, g.r3.bottom]},
    {name:"Diag ↘", arr:[g.r1.top, g.r2.center, g.r3.bottom]},
    {name:"Diag ↗", arr:[g.r1.bottom, g.r2.center, g.r3.top]},
  ];
  for(const L of lines){
    const [a,b,c]=L.arr;
    if(a===b && b===c){
      if(a==="BET300") return {kind:"jackpot", prize:10000, line:L.name, symbol:a};
      return {kind:"triple", prize:5000, line:L.name, symbol:a};
    }
  }
  for(const L of lines){
    const [a,b,c]=L.arr;
    if(a===b || a===c || b===c){
      const sym = (a===b)?a : (a===c)?a : b;
      return {kind:"pair", prize:2000, line:L.name, symbol:sym};
    }
  }
  return {kind:"none", prize:1000, line:null, symbol:null};
}

/* ===== Spin ===== */
const spinBtn=document.getElementById('spinBtn');
const claimBtn=document.getElementById('claimBtn');
const title=document.getElementById('title');
const resultLine=document.getElementById('resultLine');
const amount=document.getElementById('amount');
const stampLine=document.getElementById('stampLine');

const prizeModal=document.getElementById('prizeModal');
const mTitle=document.getElementById('mTitle');
const mPrize=document.getElementById('mPrize');
const mCode=document.getElementById('mCode');
const mTs=document.getElementById('mTs');
const mClaim=document.getElementById('mClaim');
const mClose=document.getElementById('mClose');

function setAmount(n){ amount.textContent = n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}); }

function animateSpin(targetCenters){
  return new Promise(resolve=>{
    const steps=[40,50,60], speed=[14,12,10];
    const stopTicks = soundOn ? AudioKit.spinTick() : null;
    const start = performance.now();
    const init = [Math.floor(Math.random()*N),Math.floor(Math.random()*N),Math.floor(Math.random()*N)];
    function frame(t){
      const K = (ri)=>Math.min(1, (t-start)/speed[ri]/steps[ri]);
      const E = (k)=>1-Math.pow(1-k,3);
      const c1 = (K(0)>=1) ? targetCenters[0] : ( (Math.floor(init[0]+E(K(0))*steps[0])) % N );
      const c2 = (K(1)>=1) ? targetCenters[1] : ( (Math.floor(init[1]+E(K(1))*steps[1])) % N );
      const c3 = (K(2)>=1) ? targetCenters[2] : ( (Math.floor(init[2]+E(K(2))*steps[2])) % N );
      renderFromCenters(c1,c2,c3);
      if(K(0)>=1 && K(1)>=1 && K(2)>=1){
        if(stopTicks) stopTicks(); resolve();
      }else requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  });
}

/* WhatsApp */
function whatsappText(prizeLabel){
  const code = localStorage.getItem('slot_code') || '(SIN-COD)';
  const ts   = localStorage.getItem('slot_ts')   || tsString();
  return `Hola, gané ${prizeLabel} en el Slot Express y quiero reclamarlo con mi próxima carga. Código: ${code} · ${ts}`;
}

/* Countdown */
const countdownEl=document.getElementById('countdown');
function tickCountdown(){
  const now=new Date();
  const end=new Date(now.getFullYear(),now.getMonth(),now.getDate(),23,59,0,0).getTime();
  const ms=end-Date.now(); const total=Math.max(0,Math.floor(ms/1000));
  const h=Math.floor(total/3600), m=Math.floor((total%3600)/60), s=total%60;
  countdownEl.textContent=h>0?`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
setInterval(tickCountdown,1000); tickCountdown();

/* Init */
renderFromCenters(0,1,2); setAmount(0); title.textContent="—"; resultLine.textContent="—";
document.addEventListener('click',()=>AudioKit.ctx.resume(),{once:true});

/* Handler */
spinBtn.addEventListener('click', async ()=>{
  if(spinning) return;
  spinning=true; spinBtn.disabled=true; claimBtn.disabled=true;

  const centersTarget = pickCenters();
  await animateSpin(centersTarget);

  const grid = buildGridFromFinals();
  const verdict = evaluateLines(grid);
  const centers = [grid.r1.center, grid.r2.center, grid.r3.center];

  /* === Bloque EXACTO que pediste como base === */
  title.textContent =
    (verdict.kind==="jackpot") ? "🏆 ¡JACKPOT $10.000!" :
    (verdict.kind==="triple")  ? "🎉 ¡3 iguales!" :
    (verdict.kind==="pair")    ? "✨ ¡2 iguales!" :
                                 "🎁 Premio garantizado";

  const lineTxt = verdict.line ? ` · Línea: ${verdict.line}` : '';
  const centersTxt = `Centro: ${centers.join(" | ")}`;
  resultLine.textContent =
    (verdict.kind==="jackpot") ? `3 logos BET300${lineTxt}. ${centersTxt}` :
    (verdict.kind==="triple")  ? `3 iguales${lineTxt}. ${centersTxt}` :
    (verdict.kind==="pair")    ? `2 iguales${lineTxt}. ${centersTxt}` :
                                 `Sin acierto. ${centersTxt}`;
  /* === fin bloque base === */

  setAmount(verdict.prize);
  const ts = tsString(new Date());
  const code = await makeClaimCode(verdict.prize.toString());
  localStorage.setItem('slot_code',code);
  localStorage.setItem('slot_ts',ts);
  stampLine.textContent = `Código: ${code} · ${ts}`;

  // Modal
  mTitle.textContent = title.textContent;
  mPrize.textContent = verdict.prize.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
  mCode.textContent = code; mTs.textContent = ts;
  const msg = whatsappText(mPrize.textContent);
  mClaim.onclick=()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;

  claimBtn.disabled=false;
  if(soundOn) AudioKit.win();
  prizeModal.style.display="flex";

  spinning=false; spinBtn.disabled=false;
});

claimBtn.addEventListener('click', ()=>{
  const msg = whatsappText(amount.textContent);
  location.href = `https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
});
mClose.addEventListener('click', ()=>{ prizeModal.style.display="none"; });
prizeModal.addEventListener('click', (e)=>{ if(e.target===prizeModal) prizeModal.style.display="none"; });

/* Responsive: sin scroll en móvil */
function fitHeights(){
  const isMobile = window.innerWidth < 520;
  const cellH = isMobile ? 92 : 120;
  document.querySelectorAll('.cell').forEach(c=>{ c.style.height = cellH+"px"; });
}
addEventListener('resize', ()=>{ clearTimeout(window.__fitTo); window.__fitTo=setTimeout(fitHeights,120); });
fitHeights();
</script>
</body>
</html>
